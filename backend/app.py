# -*- coding: utf-8 -*-
"""Untitled4.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/14t-q0hpvT1RmTYPxLVMyUIYuJSXVntYA
"""

# app.py
from flask import Flask, request, jsonify
from flask_cors import CORS
from agarwalwork import DatabaseManager, AptitudeTestManager
from sanyamwork import PersonalityAnalyzer
import json

# --- INITIALIZATION ---
app = Flask(__name__)
# CORS allows the React frontend to communicate with this backend
CORS(app)

# Initialize your backend modules
db_manager = DatabaseManager('career_counseling.db')
aptitude_manager = AptitudeTestManager(db_manager)
personality_analyzer = PersonalityAnalyzer()
print("Backend server initialized successfully!")

# --- API ENDPOINTS ---
@app.route('/')
def index():
    return "Career Counseling Backend is running!"

@app.route('/aptitude-test/questions', methods=['GET'])
def get_questions():
    """Endpoint to get questions for the aptitude test"""
    try:
        questions = aptitude_manager.get_test_questions(num_questions=8)
        # We don't send the correct answer to the client
        for q in questions:
            del q['correct_answer']
            del q['explanation']
        return jsonify(questions)
    except Exception as e:
        return jsonify({"error": str(e)}), 500

@app.route('/aptitude-test/submit', methods=['POST'])
def submit_test():
    """Endpoint to submit test answers and get results"""
    try:
        data = request.json
        user_id = data.get('user_id', 1)  # Using a default user_id=1 for now
        user_responses = data.get('answers')

        all_questions_in_db = aptitude_manager.get_test_questions(num_questions=100)
        full_questions_map = {q['question_id']: q for q in all_questions_in_db}

        eval_responses = []
        for res in user_responses:
            question_id = res['question_id']
            if question_id in full_questions_map:
                question_data = full_questions_map[question_id]
                eval_responses.append({
                    'question_id': question_id,
                    'category': question_data['category'],
                    'user_answer': res['user_answer'],
                    'correct_answer': question_data['correct_answer']
                })

        test_id = db_manager.save_test_result(user_id, "General Aptitude", 0)
        results = aptitude_manager.evaluate_test(user_id, test_id, eval_responses)
        recommendations = aptitude_manager.generate_career_recommendations(user_id, results)

        return jsonify({"results": results, "recommendations": recommendations})
    except Exception as e:
        print(f"Error submitting test: {e}")
        return jsonify({"error": str(e)}), 500

@app.route('/careers', methods=['GET'])
def get_careers():
    """Endpoint to get all career profiles for the explorer page"""
    try:
        careers = db_manager.get_all_careers()
        career_explorer_data = {}
        for career in careers:
            category = career.get('category', 'General').capitalize()
            if category not in career_explorer_data:
                career_explorer_data[category] = []
            career_explorer_data[category].append(career)
        return jsonify(career_explorer_data)
    except Exception as e:
        return jsonify({"error": str(e)}), 500

@app.route('/analyze-essay', methods=['POST'])
def analyze_essay():
    """Endpoint for NLP-based essay analysis"""
    try:
        data = request.json
        essay_text = data.get('essay')
        if not essay_text:
            return jsonify({"error": "Essay text is required"}), 400
        analysis = personality_analyzer.analyze_career_essay(essay_text)
        return jsonify(analysis)
    except Exception as e:
        return jsonify({"error": str(e)}), 500

# --- RUN THE SERVER ---
if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=True)